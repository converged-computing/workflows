apiVersion: flux-framework.org/v1alpha1
kind: MiniCluster

metadata:
  name: materials-science
  namespace: flux-operator
spec:
  # localDeploy needs to be true for volumes on the host
  localDeploy: true

  # Number of pods to create for MiniCluster
  size: 4

  # Disable verbose output and run timing
  logging:
    quiet: false

  # Named volumes bound to containers, we assume they are all host volumes
  # This is where I downloaded and extracted my sample datasets
  volumes:
    data:      
      path: /tmp/data-volumes

  containers:
    - image: ghcr.io/converged-computing/nsdf-materialscience:ubuntu-20.04
      workingDir: /data
      command: python3 /code/preprocess_radiographs.py preprocess /data radiographic_scan_id_112536
      
      # This says to mount the volume called "data"  to "/data" in the container
      volumes:
        data:
          path: /data
          
      # custom preCommand logic (run at start of script)
      # here we make sure PATH and Pythonpath are added to flux
      preCommand: |
        asFlux="sudo -u flux -E PYTHONPATH=$PYTHONPATH -E PATH=$PATH"